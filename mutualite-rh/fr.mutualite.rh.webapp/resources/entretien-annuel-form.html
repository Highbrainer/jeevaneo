<!DOCTYPE HTML>
<html>
<head>
<meta charset="ISO-8859-1">
<!-- <script src="/files/webix/webix.js" type="text/javascript"></script> -->
<script src="http://cdn.webix.com/edge/webix.js" type="text/javascript"></script>
<link rel="stylesheet" href="http://cdn.webix.com/edge/webix.css"
	type="text/css">
<link rel="stylesheet" href="/files/webix/orange/webix.css"
	type="text/css">
<!-- <script src="/files/webix/orange/webix.js" type="text/javascript"></script> -->
<script src="/files/webix/orange/skin.js" type="text/javascript"></script>
<script type="text/javascript">
	webix.debug = !true;
	webix.debug_size = !true;
	webix.debug_render = !true;
	webix_debug_proto = !true;
	webix.debug_time = !true;
</script>
<link rel="stylesheet" type="text/css" href="entretien.css">
<link rel="stylesheet" type="text/css" href="entretien-custom.css">

<script type="text/javascript">
	function val(s) {
		if (null == s) {
			return "";
		}
		/* if(s=="null") {
			return "";
		} */
		return s;
	}
	function getParameterByName(name, url) {
		if (!url)
			url = window.location.href;
		name = name.replace(/[\[\]]/g, "\\$&");
		var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"), results = regex
				.exec(url);
		if (!results)
			return null;
		if (!results[2])
			return '';
		return decodeURIComponent(results[2].replace(/\+/g, " "));
	}
	var rootDate = new Date();
	var bean = null;
	var formbean = null;

	function validate() {
		setTimeout("_validate();", 500);
	}
	function _validate() {
		if (bean.enCours) {
			enregistrerThen(exportPdf);
		} else {
			exportPdf();
		}
	}

	function exportPdf() {
		setTimeout("_exportPdf();", 500);
	}

	function _exportPdf() {
		webix.ajax()/*.sync()*/.headers({
			"Content-type" : "application/json",
			"Authorization" : "Bearer " + window.sessionStorage.token
		}).post("/rest/entretiens-annuels/" + bean.cdoId + "/validate").then(
				function(realdata) {

					window.location = "/rest/entretiens-annuels/" + bean.cdoId
							+ ".pdf?token=" + window.sessionStorage.token;
					/* webix.send("/rest/entretiens-annuels/"
							+ bean.cdoId + ".pdf", {
						token : window.sessionStorage.token
					}, "GET", "_blank"); */
				}).fail(function(err) {
			webix.alert("Echec de la validation!\n" + err.responseText);
		});
	}
	function isFunction(functionToCheck) {
		var getType = {};
		return functionToCheck
				&& getType.toString.call(functionToCheck) === '[object Function]';
	}
	function home() {
		webix.confirm("Si vous continuez, les modifications non enregistrées seront perdues!", function(result){
			if (result) {
				console.log(history);
				console.log(history.replaceState);
			history.replaceState({}, "Accueil", "/files/entretien-list.html");
			window.location = "/files/entretien-list.html";
			}
		});		
	}
	function enregistrer() {
		setTimeout("enregistrerThen(function() {location.reload();});", 500);
	}
	function enregistrerThen(thenFunc) {
		var promise = webix.ajax()/*.sync()*/.headers({
			"Content-type" : "application/json",
			"Authorization" : "Bearer " + window.sessionStorage.token
		}).post("/rest/entretiens-annuels/" + bean.cdoId + "/entretien", bean)
				.then(function(realdata) {
					bean.souhaitRemovals = [];
					bean.souhaits = [];
					bean.souhaitsEvaluateur = [];
					bean.missionPrincipaleRemovals = [];
					bean.missionsPrincipales = [];
					bean.missionsSpecifiques = [];
					bean.missionSpecifiqueRemovals = [];
					//bean.objectifs = [];

					for ( var i in bean.objectifs) {
						bean.objectifs[i].added = false;
					}
					bean.objectifRemovals = [];
					if (thenFunc != null) {
						thenFunc();
					} else {
						webix.message("Enregistré!");/*window.location.reload(true);*/
					}
				}).fail(
						function(err) {
							/* if (isFunction(thenFunc)) {
								console.log(thenFunc);
								thenFunc();
							} else {
								//TODO il faudrait discernet l'erreur d'enregistrement du "pas en cours!"
								console.log(err);
							} */
							webix.alert("Echec de l'enregistrement! \n"
									+ err.responseText);
						});

	}
</script>
</head>
<body>
	<div id="data_container"></div>
	<div id="header" style="display: none">
		<table style="width: 100%">
			<tr>
				<td>
					<div>
						<span class="cartouche-titre">Nom :</span>
						#entretien.photoEmploye.nom#
					</div>
					<div>
						<span class="cartouche-titre">Prénom :</span>
						#entretien.photoEmploye.prenom#
					</div>
					<div>
						<span class="cartouche-titre">Service :</span>
						#entretien.photoEmploye.etablissement#
					</div>
					<div>
						<span class="cartouche-titre">Poste occupé :</span>
						#entretien.photoEmploye.emploi#
						#entretien.photoEmploye.classification#
					</div>
					<div>
						<span class="cartouche-titre">Date d'entrée dans
							l'entreprise : </span> #entretien.photoEmploye.dateEmbauche#
					</div>
				</td>
				<td>
					<div>
						<span class="cartouche-titre">Responsable hiérarchique :</span>
						#entretien.photoEmploye.responsable#
					</div>
					<div>
						<span class="cartouche-titre">Entretien mené par :</span>
						#form.menePar#
					</div>
					<div>
						<span class="cartouche-titre">Date de l'entretien :</span>
						#form.date#
					</div>
					<div>
						<span class="cartouche-titre">Date du précédent entretien :</span>
						#entretien.photoEmploye.datePrecedentEntretienAnnuel#
					</div>
					<div>
						<span class="cartouche-titre">Diplômes :</span>
						#entretien.photoEmploye.diplomes#
					</div>
				</td>
			</tr>
		</table>
	</div>
	<script>
		var matricule = getParameterByName("matricule");

		var id = getParameterByName("id");

		var url = id != null ? "/rest/entretiens-annuels/" + id
				: "/rest/employes/" + matricule + "/entretien-annuel/current";

		webix
				.ajax()
				.headers({
					"Authorization" : "Bearer " + window.sessionStorage.token
				})
				.get(url)
				.fail(
						function() {
							webix
									.alert(
											'Vous ne pouvez pas accéder à cet entretien!',
											function() {
												webix
														.send(
																"/files/choix-employe.html",
																"GET");
											});
						})
				.then(
						function(rawformbean) {
							var urlEntretien = id != null ? "/rest/entretiens-annuels/"
									+ id + "/entretien"
									: "/rest/employes/"
											+ matricule
											+ "/entretien-annuel/current/entretien";
							webix
									.ajax()
									.headers(
											{
												"Authorization" : "Bearer "
														+ window.sessionStorage.token
											})
									.get(urlEntretien)
									.fail(
											function() {
												webix
														.alert('Vous ne pouvez pas accéder à cet entretien.');
											})
									.then(
											function(rawentretienbean) {
												createForm(rawformbean.json(),
														rawentretienbean.json());
											});
						});

		// objectif
		function ajouterObjectif() {
			item = {
				added : true,
				libelle : "",
				echeance : "",
				indicateurs : "",
				moyens : ""
			};

			var row = $$("datatable_objectifs").add(item);
			bean.objectifs.push(item);
			//$$("datatable_objectifs").editRow(row);
			console.log($$("datatable_objectifs").editStop);
			//$$("datatable_objectifs").editStop = function() {console.log("GROS STOP ");}

			$$("truc").focus();
			$$("datatable_objectifs").editCell(row, "libelle").focus();
			/* var pop = webix.ui({
				view   : 'popup',
				id     : 'error_pop',
				css    : { 'box-shadow': 'none' },
				body   : {rows:[
					{ css:{'font-weight':'bold'},
			          autoheight:true,
			          borderless:true,
			          template: 'Cliquez ici pour éditer votre nouvel objectif...'},
			    
				]},
				$init : function() {
			    	setTimeout(function() {$$('error_pop').hide("error_pop");}, 2000);
			    	}
			}).show($$('datatable_objectifs').$view); */
		}

		function removeObjectif(identifiant) {
			item = $$("datatable_objectifs").getItem(identifiant);
			item.removed = true;
			if (!item.added) {
				bean.objectifRemovals.push(item);
			}
			bean.objectifs = bean.objectifs.filter(function(i) {
				return i.id != identifiant;
			});
			$$("datatable_objectifs").filter(function(obj) {
				return !obj.removed;
			});
			$$("truc").hide();
		}
		//fin objectif

		// mission principale
		function ajouterMissionPrincipale() {
			item = {
				added : true,
				mission : "Décrire la mission ici...",
				eval : "-/+"
			};
			$$("datatable_evaluationsTenuePosteMissionsPrincipales").add(item);
			bean.evaluationsTenuePosteMissionsPrincipales.push(item);
		}

		function removeMissionPrincipale(identifiant) {
			item = $$("datatable_evaluationsTenuePosteMissionsPrincipales")
					.getItem(identifiant);
			item.removed = true;
			if (!item.added) {
				bean.missionPrincipaleRemovals.push(item);
			}
			bean.evaluationsTenuePosteMissionsPrincipales = bean.evaluationsTenuePosteMissionsPrincipales
					.filter(function(i) {
						return i.id != identifiant;
					});
			$$("datatable_evaluationsTenuePosteMissionsPrincipales").filter(
					function(obj) {
						return !obj.removed;
					});
		}
		//fin mission principale

		// mission specifique
		function ajouterMissionSpecifique() {
			item = {
				added : true,
				mission : "Décrire la mission ici...",
				eval : "-/+"
			};
			$$("datatable_evaluationsTenuePosteMissionsSpecifiques").add(item);
			bean.evaluationsTenuePosteMissionsSpecifiques.push(item);
		}

		function removeMissionSpecifique(identifiant) {
			item = $$("datatable_evaluationsTenuePosteMissionsSpecifiques")
					.getItem(identifiant);
			item.removed = true;
			if (!item.added) {
				bean.missionSpecifiqueRemovals.push(item);
			}
			bean.evaluationsTenuePosteMissionsSpecifiques = bean.evaluationsTenuePosteMissionsSpecifiques
					.filter(function(i) {
						return i.id != identifiant;
					});
			$$("datatable_evaluationsTenuePosteMissionsSpecifiques").filter(
					function(obj) {
						return !obj.removed;
					});
		}
		//fin mission specifique

		// souhait
		function ajouterSouhait() {
			item = {
				added : true,
				texte : "Saisir votre souhait ici...",
				avisEvaluateur : "Favorable"
			};
			$$("datatable_souhaits").add(item);
			bean.souhaits.push(item);
		}

		function removeSouhait(identifiant) {
			item = $$("datatable_souhaits").getItem(identifiant);
			item.removed = true;
			if (!item.added) {
				bean.souhaitRemovals.push(item);
			}
			bean.souhaits = bean.souhaits.filter(function(i) {
				return i.id != identifiant;
			});
			$$("datatable_souhaits").filter(function(obj) {
				return !obj.removed;
			});
		}
		//fin souhait

		function ajouterSouhaitEvaluateur() {
			item = {
				added : true,
				texte : "Saisir votre souhait ici...",
				avisEvaluateur : "Favorable"
			};
			$$("datatable_souhaits_evaluateur").add(item);
			bean.souhaitsEvaluateur.push(item);
		}

		function removeSouhaitEvaluateur(identifiant) {
			item = $$("datatable_souhaits_evaluateur").getItem(identifiant);
			item.removed = true;
			if (!item.added) {
				bean.souhaitEvaluateurRemovals.push(item);
			}
			bean.souhaitsEvaluateur = bean.souhaitsEvaluateur
					.filter(function(i) {
						return i.id != identifiant;
					})
			$$("datatable_souhaits_evaluateur").filter(function(obj) {
				return !obj.removed;
			});
		}

		function createForm(formbean, entretienbean) {
			this.formbean = formbean;
			this.bean = entretienbean;
			bean.souhaitsEvaluateur = [];
			bean.souhaits = [];
			bean.souhaitEvaluateurRemovals = [];
			bean.souhaitRemovals = [];
			bean.missionsPrincipales = [];
			bean.missionPrincipaleRemovals = [];
			bean.missionsSpecifiques = [];
			bean.missionSpecifiqueRemovals = [];
			//bean.objectifs = [];
			bean.objectifRemovals = [];
			var superbean = new Object();
			superbean.form = formbean;
			superbean.entretien = entretienbean;
			if (!superbean.entretien.photoEmploye.datePrecedentEntretienAnnuel) {
				superbean.entretien.photoEmploye.datePrecedentEntretienAnnuel = "";
			}
			console.log(superbean);

			webix.editors.placeholderpopup = webix.extend({
				focus : function() {
					console.log(this);
					var textareaId = this.getInputNode().config.id;
					if (this.config.placeholder) {
						ta = document.getElementsByName(textareaId)[0]
						ta.placeholder = this.config.placeholder
								+ "\nMAJ+ENTREE: retour à la ligne";
					}
					ta.style.width = 600;
					ta.style.height = 200;
					this.getInputNode().focus();
				}
			}, webix.editors.popup);
			/* webix.editors.placeholderpopup.linkInput=function(node){
					console.log(e);
				webix._event(webix.toNode(node), "keydown", webix.bind(function(e){
				
					var code = e.which || e.keyCode, list = this.getInputNode();
					if(!list.isVisible()) return;

					if(code === 40){
						if(list.moveSelection)
							list.moveSelection("down");
						webix.UIManager.setFocus(list);
					} 
					// shift+enter support for 'popup' editor
					else if(code === 13 && ( e.target.nodeName !=="TEXTAREA" || !e.shiftKey))
						webix.callEvent("onEditEnd", []);
					
				}, this));
			} */

			var page = {
				id : "mainForm",
				container : "data_container",
				view : "form",
				scroll : false,
				width : 1280,
				align : "center",
				rows : [
						{
							view : "toolbar",
							cols : [
									{
										view : "template",
										type : "clean",
										css : "big-title",
										height : 80,
										template : "<img height='80px' style='float:left;' src=\"/files/logo-mfca-monochrome.png\"/><div>MFCA - Formulaire d'entretien annuel<br/> pour #prenom# #nom#</div>",
										data : formbean
									}, {
										view : "button",
										type : "iconButton",
										zzzcss : "webix_icon fa-home",
										icon : "home",
										align : "right",
										label : "Retour",
										width : 90,
										click : "home"
									},{
										view : "button",
										type : "iconButton",
										zzzcss : "webix_icon fa-save",
										icon : "save",
										align : "right",
										label : "Enregistrer",
										width : 120,
										click : "enregistrer"
									}, {
										view : "button",
										type : "iconButton",
										icon : "file-pdf-o",
										align : "right",
										label : "Valider",
										width : 100,
										click : "validate"
									} ]
						},
						{
							view : "template",
							data : superbean,
							height : 120,
							template : document.getElementById("header").innerHTML
						},

						{
							multi : true,
							view : "accordion",
							type : "wide",
							rows : [

									{
										header : "Bilan de l'année écoulée",
										body : {
											rows : [
													{
														id : "bilanFaitsMarquants",
														view : "textarea",
														height : 200,
														label : "Quels sont les faits qui ont marqué l'exercice de votre fonction cette année?",
														labelPosition : "top",
														value : val(entretienbean.bilanFaitsMarquants),
														on : {
															"onChange" : function(
																	v) {
																bean.bilanFaitsMarquants = v;
															}
														}
													},
													{
														id : "bilanActivitesSatisfactions",
														view : "textarea",
														height : 200,
														label : "Quelles sont les activités principales de votre poste qui vous ont apporté le plus de satisfaction?",
														labelPosition : "top",
														value : val(entretienbean.bilanActivitesSatisfactions),
														on : {
															"onChange" : function(
																	v) {
																bean.bilanActivitesSatisfactions = v;
															}
														}
													},
													{
														id : "bilanActivitesDifficultes",
														view : "textarea",
														height : 200,
														label : "Quelles sont les activités qui vous ont posé le plus de difficultés?",
														labelPosition : "top",
														value : val(entretienbean.bilanActivitesDifficultes),
														on : {
															"onChange" : function(
																	v) {
																bean.bilanActivitesDifficultes = v;
															}
														}
													} ]
										}
									},
									{
										header : "Evaluation de la tenue du poste",
										body : {
											id : "evaluationsTenuePosteMissionsPrincipales",
											rows : [
													{
														view : "label",
														label : "<span class='webix_inp_top_label '>Missions principales</span>",
														align : "left"
													},
													{
														view : "datatable",
														id : "datatable_evaluationsTenuePosteMissionsPrincipales",
														columns : [
																{
																	id : "mission",
																	editor : "text",
																	header : "Missions",
																	width : 900
																},
																{
																	id : "eval",
																	editor : "richselect",
																	options : [
																			"-",
																			"-/+",
																			"+" ],
																	header : "Evaluation",
																	width : 100
																},
																{
																	id : "remove",
																	width : 280,
																	header : "",
																	css : "webix_el_button",
																	template : "<a href='javascript:removeMissionPrincipale(#id#)'><button type=\"button\" class=\"webix_img_btn\" style=\"line-height:32px;\"><span class=\"webix_icon_btn fa-minus-circle\" style=\"max-width:32px;\"></span>Supprimer</button></a>"
																} ],
														autowidth : true,
														autoheight : true,
														editable : true,
														data : bean.evaluationsTenuePosteMissionsPrincipales
													},
													{
														view : "button",
														type : "icon",
														icon : "plus-circle",
														label : "Ajouter une mission",
														align : "right",
														autowidth : true,
														click : ajouterMissionPrincipale
													},
													{
														view : "textarea",
														height : 100,
														label : "Commentaires sur les missions principales:",
														labelPosition : "top",
														value : val(entretienbean.commentaireEvaluationsTenuePosteMissionsPrincipales),
														on : {
															"onChange" : function(
																	v) {
																bean.commentaireEvaluationsTenuePosteMissionsPrincipales = v;
															}
														}
													},
													{
														view : "label",
														label : "<span class='webix_inp_top_label '>Missions spécifiques</span>",
														align : "left"
													},
													{
														view : "datatable",
														id : "datatable_evaluationsTenuePosteMissionsSpecifiques",
														columns : [
																{
																	id : "mission",
																	editor : "text",
																	header : "Missions",
																	width : 900
																},
																{
																	id : "eval",
																	editor : "richselect",
																	options : [
																			"-",
																			"-/+",
																			"+" ],
																	header : "Evaluation",
																	width : 100
																},
																{
																	id : "remove",
																	width : 280,
																	header : "",
																	css : "webix_el_button",
																	template : "<a href='javascript:removeMissionSpecifique(#id#)'><button type=\"button\" class=\"webix_img_btn\" style=\"line-height:32px;\"><span class=\"webix_icon_btn fa-minus-circle\" style=\"max-width:32px;\"></span>Supprimer</button></a>"
																} ],
														autowidth : true,
														autoheight : true,
														editable : true,
														data : bean.evaluationsTenuePosteMissionsSpecifiques
													},
													{
														view : "button",
														type : "icon",
														icon : "plus-circle",
														label : "Ajouter une mission",
														align : "right",
														autowidth : true,
														click : ajouterMissionSpecifique
													},
													{
														view : "textarea",
														height : 100,
														label : "Commentaires sur les missions spécifiques:",
														labelPosition : "top",
														value : val(entretienbean.commentaireEvaluationsTenuePosteMissionsSpecifiques),
														on : {
															"onChange" : function(
																	v) {
																bean.commentaireEvaluationsTenuePosteMissionsSpecifiques = v;
															}
														}
													},
													{
														view : "segmented",
														//																editor : "richselect",
														options : [ "Oui",
																"Non" ],
														label : "La fiche de fonction du salarié doit-elle être revue?",
														//															labelAlign:"left",
														labelWidth : 1000,
														width : 1200,
														value : (entretienbean.revoirFicheFonction == null || !entretienbean.revoirFicheFonction) ? "Non"
																: "Oui",
														on : {
															"onChange" : function(
																	v) {
																bean.revoirFicheFonction = (v == "Oui" ? true
																		: false);
															}
														}
													},
													{
														view : "textarea",
														height : 100,
														label : "Si oui, précisez:",
														labelPosition : "top",
														value : val(entretienbean.revoirFicheFonctionPrecisions),
														on : {
															"onChange" : function(
																	v) {
																bean.revoirFicheFonctionPrecisions = v;
															}
														}
													}, ]
										}
									},

									{
										collapsed : false,
										header : "Evaluation des compétences - Savoir-Faire",
										body : {
											id : "evaluationCompetencesSavoirFaire",

											rows : []
										}
									},

									{
										collapsed : false,
										header : "Evaluation des compétences - Savoir-Etre",
										body : {
											id : "evaluationCompetencesSavoirEtre",

											rows : []
										}
									},

									{
										collapsed : false,
										header : "Evaluation générale du salarié",
										body : {

											rows : [

													{
														view : "textarea",
														height : 100,
														label : "Points forts du salarié:",
														labelPosition : "top",
														value : val(entretienbean.pointsForts),
														on : {
															"onChange" : function(
																	v) {
																bean.pointsForts = v;
															}
														}
													},
													{
														view : "textarea",
														height : 100,
														label : "Points à améliorer:",
														labelPosition : "top",
														value : val(entretienbean.pointsAmeliorer),
														on : {
															"onChange" : function(
																	v) {
																bean.pointsAmeliorer = v;
															}
														}
													} ]
										}
									},

									{
										collapsed : false,
										header : "Atteinte des objectifs précédents",
										body : {
											id : "objectifsPrecedents",

											rows : []
										}
									},
									{
										header : "Bilan des formations effectuées",
										body : {
											id : "bilanFormations",
											rows : []
										}
									},

									{
										header : "Formation professionnelle",
										body : {
											rows : [
													{
														view : "datatable",
														id : "datatable_souhaits",
														columns : [
																{
																	id : "texte",
																	editor : "text",
																	header : "Formations souhaitées par le salarié",
																	width : 700
																},
																{
																	id : "avisEvaluateur",
																	editor : "richselect",
																	options : [
																			"Favorable",
																			"Non favorable",
																			"Favorable mais non prioritaire" ],
																	header : "Avis de l'évaluateur",
																	width : 300
																},
																{
																	id : "remove",
																	width : 280,
																	header : "",
																	css : "webix_el_button",
																	template : "<a href='javascript:removeSouhait(#id#)'><button type=\"button\" class=\"webix_img_btn\" style=\"line-height:32px;\"><span class=\"webix_icon_btn fa-minus-circle\" style=\"max-width:32px;\"></span>Supprimer</button></a>"
																} ],
														autowidth : true,
														autoheight : true,
														editable : true,
														data : bean.souhaitsFormationSalarie
													},
													{
														view : "button",
														type : "icon",
														icon : "plus-circle",
														label : "Ajouter un souhait",
														align : "right",
														autowidth : true,
														click : ajouterSouhait
													},
													{
														view : "datatable",
														id : "datatable_souhaits_evaluateur",
														columns : [
																{
																	id : "texte",
																	editor : "text",
																	header : "Formations souhaitées par l'évaluateur",
																	width : 1000
																},
																{
																	id : "remove",
																	width : 280,
																	header : "",
																	css : "webix_el_button",
																	template : "<a href='javascript:removeSouhaitEvaluateur(#id#)'><button type=\"button\" class=\"webix_img_btn\" style=\"line-height:32px;\"><span class=\"webix_icon_btn fa-minus-circle\" style=\"max-width:32px;\"></span>Supprimer</button></a>"
																} ],
														autowidth : true,
														autoheight : true,
														editable : true,
														data : bean.souhaitsFormationEvaluateur
													}

													,
													{
														view : "button",
														type : "icon",
														icon : "plus-circle",
														label : "Ajouter un souhait évaluateur",
														align : "right",
														autowidth : true,
														click : ajouterSouhaitEvaluateur
													},
													{
														view : "textarea",
														label : "Autres actions de développement des compétences envisagées (tutorat, accompagnement,...) :",
														labelPosition : "top",
														height : 100,
														value : val(entretienbean.autresActionsDeveloppementCompetences),
														on : {
															"onChange" : function(
																	v) {
																bean.autresActionsDeveloppementCompetences = v;
															}
														}
													} ]
										}
									},

									{
										header : "Définition des objectifs pour l'année à venir",
										body : {
											id : "objectifs",
											rows : [
													{
														view : "datatable",
														id : "datatable_objectifs",
														columns : [
																{
																	id : "libelle",
																	editor : "placeholderpopup",
																	header : "Objectif",
																	width : 350,
																	placeholder : "Décrire l'objectif ici...",

																},
																{
																	id : "echeance",
																	editor : "placeholderpopup",
																	header : "Echeance",
																	width : 150,
																	placeholder : "Décrire l'échéance ici...",
																},
																{
																	id : "indicateurs",
																	editor : "placeholderpopup",
																	header : "Indicateurs de performance",
																	width : 250,
																	placeholder : "Lister les indicateurs de performance ici...",

																},
																{
																	id : "moyens",
																	editor : "placeholderpopup",
																	header : "Moyens mis à disposition",
																	width : 250,
																	placeholder : "Indiquer les moyens à mettre à disposition ici...",
																},
																{
																	id : "remove",
																	width : 280,
																	header : "",
																	css : "webix_el_button",
																	template : "<a href='javascript:removeObjectif(#id#)'><button type=\"button\" class=\"webix_img_btn\" style=\"line-height:32px;\"><span class=\"webix_icon_btn fa-minus-circle\" style=\"max-width:32px;\"></span>Supprimer</button></a>"
																} ],
														autowidth : true,
														autoheight : true,
														editable : true,
														data : bean.objectifs
													},
													{
														id : "truc",
														view : "button",
														type : "hidden",
														icon : "plus-circle",
														label : "Bidon",
														align : "right",
														//autowidth : true,
														height : 0,
														visible : false
													},
													{
														view : "button",
														type : "icon",
														icon : "plus-circle",
														label : "Ajouter un objectif",
														align : "right",
														autowidth : true,
														click : ajouterObjectif
													},
													{
														view : "textarea",
														height : 100,
														label : "Commentaires sur les objectifs:",
														labelPosition : "top",
														value : val(entretienbean.objectifsCommentaires),
														on : {
															"onChange" : function(
																	v) {
																bean.objectifsCommentaires = v;
															}
														}
													} ]
										}
									},

									{
										header : "Synthèse de l'entretien",
										body : {
											cols : [
													{
														view : "textarea",
														height : 300,
														label : "Evaluateur:",
														labelPosition : "top",
														value : val(entretienbean.syntheseEvaluateur),
														on : {
															"onChange" : function(
																	v) {
																bean.syntheseEvaluateur = v;
															}
														}
													},
													{
														view : "textarea",
														height : 300,
														label : "Salarié:",
														labelPosition : "top",
														value : val(entretienbean.syntheseSalarie),
														on : {
															"onChange" : function(
																	v) {
																bean.syntheseSalarie = v;
															}
														}
													}, ]
										}

									}

							]
						},
						{
							view : "fieldset",
							body : {
								cols : [
										{
											view : "template",
											height : 100,
											type : "clean",
											data : entretienbean,
											template : "Fait le #date#"
										},
										{
											view : "template",
											type : "clean",
											data : formbean,
											template : "Signature du salarié: #prenom# #nom#"
										},
										{
											view : "template",
											type : "clean",
											data : formbean,
											template : "Signature du chargé d'entretien: #menePar#"
										} ]
							}
						}, {
							cols : [ {}, {
								view : "button",
								type : "iconButton",
								icon : "home",
								align : "right",
								label : "Retour",
								width : 90,
								click : "home"
							},{
								view : "button",
								type : "iconButton",
								icon : "save",
								align : "right",
								label : "Enregistrer",
								width : 120,
								click : "enregistrer"
							}, {
								view : "button",
								type : "iconButton",
								icon : "check",
								align : "right",
								label : "Valider",
								width : 100,
								click : "validate"
							} ]
						} ]
			};
			webix.ui(page);

			//Evaluations de formations
			$$("bilanFormations").addView({
				view : "label",
				id : "label_evaluations_precentes",
				label : "Formations évaluées lors d'entretiens précédents:",
			});
			$$("bilanFormations")
					.addView(
							{
								view : "datatable",
								id : "databale_evaluations_precentes",
								columns : [
										{
											template : "<span class='webix_view webix_template'>#libelleFormation# du #dateFormation#</span>",
											width : 950
										},
										{
											template : "<span class='webix_view webix_template'>#valeur#</span>",
											width : 280
										}, ],
								autowidth : true,
								autoheight : true,
								editable : false,
								editAction : "none",
								header : false,
								url : "/rest/entretiens/"
										+ entretienbean.cdoId
										+ "/evaluations-sessions-formation-precedents-entretiens"
							});
			$$("bilanFormations").addView({
				view : "label",
				id : "spacer_evaluations_precentes",
			});
			$$("databale_evaluations_precentes").attachEvent("onAfterLoad",
					function() {
						if (!this.count()) {
							//this.showOverlay("Sorry, there is no data");
							this.hide();
							$$("label_evaluations_precentes").hide();
							$$("spacer_evaluations_precentes").hide();
						}
					});

			if (entretienbean.appreciationsSessionFormation.length < 1) {
				$$("bilanFormations")
						.addView(
								{
									view : "label",
									label : "<span class='warning'>Il n'y a pas eu de formation depuis le dernier entretien!</span>"
								});
			} else {

				$$("bilanFormations").addView({
					view : "label",
					label : "Formations à évaluer :",
				});
			}

			for ( var i in entretienbean.appreciationsSessionFormation) {
				apprec = entretienbean.appreciationsSessionFormation[i];

				$$("bilanFormations").addView(
						{
							cols : [
									{
										view : "template",
										height : 30,
										template : "" + apprec.libelleFormation
												+ " du " + apprec.dateFormation
									},
									{
										id : "appreciationsSessionFormation["
												+ i + "]",
										view : "segmented",
										width : 300,
										multiview : true,
										value : val(apprec.valeur),
										options : [ "Satisfaisant",
												"A compléter", "Inutile" ],
										on : {
											"onChange" : function(v) {
												var cmd = "bean."
														+ this.config.id
														+ ".valeur=\"" + v
														+ "\";";
												console.log("YO:" + cmd);
												eval(cmd);
											}
										}
									} ]
						}
				//, $$("mainForm").index($$("bilanFormations")) + 1
				);
			}
			if (entretienbean.appreciationsSessionFormation.length > 0) {
				$$("bilanFormations").addView({
					view : "label",
				});
			}
			$$("bilanFormations").addView({
				view : "textarea",
				height : 100,
				label : "Commentaires:",
				labelPosition : "top",
				value : val(entretienbean.commentaireBilanFormation),
				on : {
					"onChange" : function(v) {
						bean.commentaireBilanFormation = v;
					}
				}
			});

			//fin sessions formations

			// Chargement des evaluations de compétences
			createEvaluationSavoirEtreForm(formbean, entretienbean);
			createObjectifsPrecedentsForm(formbean, entretienbean);
			webix
					.ajax()
					.headers(
							{
								"Authorization" : "Bearer "
										+ window.sessionStorage.token
							})
					.get("/rest/entretien-annuel/categories-competences.json")
					.fail(
							function() {
								webix
										.alert("Erreur technique lors du chargement de l'évaluation des compétences.");
							}).then(
							function(rawCategoriesCompetencesBean) {
								createEvaluationCompetencesForm(formbean,
										entretienbean,
										rawCategoriesCompetencesBean.json());
							});
		}

		function createEvaluationCompetencesForm(formBean, entretienBean,
				categoriesCompetencesBean) {

			//init la map des competences
			entretienBean.competences = new Map();
			for (i in entretienBean.evaluationsCompetences) {
				entretienBean.competences[entretienBean.evaluationsCompetences[i].competence] = entretienBean.evaluationsCompetences[i];
			}

			//fin init map des competences

			//TITRES
			$$("evaluationCompetencesSavoirFaire").addView({
				autoheight : true,
				cols : [ {
					view : "label",
					//height : 30,
					label : ""
				}, {
					view : "template",
					width : 150,
					template : "<b>Evaluation</b>"
				}, {
					width : 150,
					view : "template",
					autoheight : true,
					template : "<b>Evolution depuis le dernier entretien</b>"
				} ]
			});
			//FIN TITRES
			var evalCompetById = new Map();

			for (i in categoriesCompetencesBean) {
				$$("evaluationCompetencesSavoirFaire").addView(
						{
							view : "label",
							align : "left",
							label : "<span><b>"
									+ categoriesCompetencesBean[i].libelle
									+ "</b></span>"
						});
				for (j in categoriesCompetencesBean[i].competences) {

					var evaluationCompetenceBean = entretienBean.competences[categoriesCompetencesBean[i].competences[j].libelle];
					if (!evaluationCompetenceBean) {
						continue;
					}
					evalCompetById[evaluationCompetenceBean.id] = evaluationCompetenceBean;
					$$("evaluationCompetencesSavoirFaire")
							.addView(
									{
										//autoheight:true,
										cols : [
												{
													view : "template",
													height : 30,
													align : "left",
													template : categoriesCompetencesBean[i].competences[j].libelle
												},
												{
													id : "categoriesCompetencesBean["
															+ i
															+ "].competences["
															+ j + "].eval",
													view : "segmented",
													width : 150,
													multiview : true,
													bean : evaluationCompetenceBean,
													value : evaluationCompetenceBean.eval,
													options : [ {
														id : "Non concerné(e)",
														value : "NC"
													}, "-", "-/+", "+" ],
													on : {
														"onChange" : function(v) {
															//webix.message("AVANT " + this.data.bean.cdoId +  " " + this.data.bean.eval);
															this.data.bean.eval = v;
															//webix.message("APRES " + this.data.bean.cdoId +  " " + this.data.bean.eval);
														}
													}
												},
												{
													id : "categoriesCompetencesBean["
															+ i
															+ "].competences["
															+ j + "].evol",
													view : "segmented",
													width : 150,
													multiview : true,
													bean : evaluationCompetenceBean,
													value : evaluationCompetenceBean.evol,
													options : [ {
														id : "Dégradation",
														value : "&#8600;"
													}, {
														id : "Stable",
														value : "&#10141;"
													}, {
														id : "Amélioration",
														value : "&#8599;"
													} ],
													on : {
														"onChange" : function(v) {
															this.data.bean.evol = v;
															//entretienBean.competences[categoriesCompetencesBean[i].competences[j].libelle].evol = v;
														}
													}
												} ]
									});
				}
			}

			//Commentaires en tant que footer
			$$("evaluationCompetencesSavoirFaire").addView({
				view : "textarea",
				height : 100,
				label : "Commentaires:",
				labelPosition : "top",
				value : val(entretienBean.commentaireCompetences),
				on : {
					"onChange" : function(v) {
						bean.commentaireCompetences = v;
					}
				}
			});
		}

		function createEvaluationSavoirEtreForm(formBean, entretienBean) {

			//TITRES
			$$("evaluationCompetencesSavoirEtre").addView({
				autoheight : true,
				cols : [ {
					view : "label",
					//height : 30,
					label : ""
				}, {
					view : "template",
					width : 150,
					template : "<b>Evaluation</b>"
				}, {
					width : 150,
					view : "template",
					autoheight : true,
					template : "<b>Evolution depuis le dernier entretien</b>"
				} ]
			});
			//FIN TITRES
			for (j in entretienBean.evaluationsSavoirEtre) {

				evaluationSEBean = entretienBean.evaluationsSavoirEtre[j];

				$$("evaluationCompetencesSavoirEtre").addView({
					//autoheight:true,
					cols : [ {
						view : "template",
						height : 30,
						align : "left",
						template : evaluationSEBean.savoirEtre
					}, {
						id : "evaluationSEBean[" + j + "].eval",
						view : "segmented",
						width : 150,
						multiview : true,
						bean : evaluationSEBean,
						value : evaluationSEBean.eval,
						options : [ "-", "-/+", "+" ],
						on : {
							"onChange" : function(v) {
								this.data.bean.eval = v;
							}
						}
					}, {
						id : "evaluationSEBean[" + j + "].evol",
						view : "segmented",
						width : 150,
						multiview : true,
						bean : evaluationSEBean,
						value : evaluationSEBean.evol,
						options : [ {
							id : "Dégradation",
							value : "&#8600;"
						}, {
							id : "Stable",
							value : "&#10141;"
						}, {
							id : "Amélioration",
							value : "&#8599;"
						} ],
						on : {
							"onChange" : function(v) {
								this.data.bean.evol = v;
							}
						}
					} ]
				});
			}

			//Commentaires en tant que footer
			$$("evaluationCompetencesSavoirEtre").addView({
				view : "textarea",
				height : 100,
				label : "Commentaires:",
				labelPosition : "top",
				value : val(entretienBean.commentaireSavoirEtre),
				on : {
					"onChange" : function(v) {
						bean.commentaireSavoirEtre = v;
					}
				}
			});
		}

		function createObjectifsPrecedentsForm(formBean, entretienBean) {

			//TITRES
			$$("objectifsPrecedents").addView({
				autoheight : true,
				cols : [ {
					view : "label",
					//height : 30,
					width : 500,
					label : "<b>Objectif</b>"
				}, {
					view : "label",
					width : 180,
					label : "<b>Atteinte</b>"
				}, {
					view : "label",
					width : 500,
					label : "<b>Commentaire</b>"
				} ]
			});
			//FIN TITRES
			for (j in entretienBean.objectifsPrecedents) {
				createObjectifPrecedentLine(entretienBean.objectifsPrecedents[j]);
			}
		}

		function createObjectifPrecedentLine(objectifPrecedent) {
			var objectifPrecedentBean = objectifPrecedent;

			$$("objectifsPrecedents")
					.addView(
							{
								//autoheight:true,
								cols : [
										{
											id : "objectifPrecedent_"
													+ objectifPrecedentBean.cdoId,
											view : "template",
											width : 500,
											align : "left",
											template : "<span style=\"width:100%;text-align:left;\">"
													+ objectifPrecedentBean.cdoId
													+ "</span>"
										},
										{
											view : "combo",
											width : 180,
											bean : objectifPrecedentBean,
											value : objectifPrecedentBean.evaluation,
											options : [ "Non atteint",
													"Partiellement atteint",
													"Atteint" ],
											on : {
												"onChange" : function(v) {
													this.data.bean.evaluation = v;
												}
											}
										},
										{
											view : "textarea",
											width : 500,
											bean : objectifPrecedentBean,
											value : objectifPrecedentBean.commentaire,
											on : {
												"onChange" : function(v) {
													this.data.bean.commentaire = v;
												}
											}
										} ]
							});

			//update le libelle
			webix
					.ajax()
					.headers(
							{
								"Authorization" : "Bearer "
										+ window.sessionStorage.token
							})
					.get(
							"/rest/objectif-precedent/"
									+ objectifPrecedentBean.cdoId + "/libelle")
					.fail(
							function() {
								webix
										.alert("Erreur technique lors du chargement du libelle d'un objectif précédent.");
							}).then(
							function(libelle) {
								$$(
										"objectifPrecedent_"
												+ objectifPrecedentBean.cdoId)
										.setHTML(libelle.text());
							});

		}

		/* //Gestion de la progressbar à la validation
		//adding progress bar functionality to it
		webix.extend($$("mainForm"), webix.ProgressBar);

		//using the functionality
		$$("mainForm").showProgress({
			type : "icon",
			delay : 3000
		}); */
	</script>
</body>
</html>